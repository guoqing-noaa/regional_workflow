<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE workflow [

<!ENTITY BOUNDARY_LEN_normal     "{{ boundary_len_hrs }}">
<!ENTITY BOUNDARY_LEN_long       "{{ boundary_long_len_hrs }}">
<!ENTITY BDYFILE_AGE_SECONDS "300">

]>

<workflow realtime="F" scheduler="slurm" cyclethrottle="24" cyclelifespan="01:00:00:00">

  <cycledef group="boundary_normal"> 00 19,21,23 4 5 2021 * </cycledef>
  <cycledef group="boundary_long"> 00 18,20,22 4 5 2021 * </cycledef>

  <log>
    <cyclestr>/mnt/lfs4/BMC/wrfruc/gge/rtma/ufs-srweather-app/regional_workflow/ush/getextrn.log</cyclestr>
  </log>

  <metatask name="test">
    <var name="len">&BOUNDARY_LEN_normal; &BOUNDARY_LEN_long;</var>
    <var name="type">normal long </var>

    <task name="get_extrn_lbcs_#type#" cycledefs="boundary_#type#" maxtries="1">

      <account>wrfruc</account><queue>windfall</queue><partition>xjet</partition>
      <command>sleep 5</command>
      <walltime>00:05:00</walltime>
      <memory>24G</memory>
      <cores>1</cores>
      <jobname>get_extrn_lbcs</jobname>
      <join><cyclestr>/tmp/test_@Y@m@d@H.log</cyclestr></join>
      <envar><name>type</name><value>#type#</value></envar>
      <envar><name>len</name><value>#len#</value></envar>

      <dependency>
        <rb><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">
          knt=-1; target=#len#/{{bc_update_interval}}
          puts "target=#{target}"
          for i in ({{ extrn_mdl_lbcs_offset_hrs }}..{{ extrn_mdl_lbcs_offset_hrs }}+#len#).step({{bc_update_interval}})
            f="{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H000"+format('%03d',i)
            if File.file?("#{f}") and (Time.now.to_i-File.mtime("#{f}").to_i&gt;&BDYFILE_AGE_SECONDS;); knt+=1; end
            puts "knt=#{knt},file=#{f}"
          end
          knt==target
        </cyclestr></rb>
      </dependency>

    </task>

   </metatask>

</workflow>
